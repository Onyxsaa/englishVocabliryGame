<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Game level 1</title>
    <link rel="stylesheet" href="/stylesheets/style.css">

</head>
<body>



    <h1 id="main-title">Let's Pronounce Correctly</h1>
    
    <div id="username-container">
        <h2>Start the game!</h2>
        <label for="username-input">Username:</label>
        <input type="text" id="username-input" required>
        <button id="save-username-button">save and start</button>
    </div>

    <div id="timer-container" style="display: none;">
        Your Time: <span id="timer">60</span> seconds
    </div>

    <div id="game-container">
        <div id="user-info">
            Hello, <strong id="username-display"></strong>! | Score: <span id="score">0</span>
        </div>

        <div id="sentence-display">
            </div>
        <div class="action-buttons-container">
             <button id="speak-button" title="Dinle">ðŸ”Š Listen</button>
        </div>
        <div id="choices-container">
            </div>
         <div class="action-buttons-container">
            <button id="next-button" title="Sonraki" disabled>Next</button>
         </div>
    </div>

    <div id="phase-transition-container">
        <h2>Level 1 completed!</h2>
        <p>Congratulations! Level 1 is completed.</p>
        <p>Total Score: <span id="phase-score">0</span></p>
        <p>level 1 time: <span id="phase1-completion-time">0</span> seconds</p>
        <div class="selections-history">
            <h3>level 1 selection history</h3>
            <ul id="phase1-history"></ul>
        </div>
        <button id="start-phase2-button">start level 2</button>
    </div>
    <!-- Skorboard bÃ¶lÃ¼mÃ¼ - Ana HTML'e ekleyin (game-over-container'dan Ã¶nce) -->
<div id="scoreboard-container" style="display: none;">
    <h2>Scoreboard - Best Players</h2>
    <table id="scoreboard-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Username</th>
                <th>Score</th>
                <th>time (sc)</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="scoreboard-body">
            <!-- Skorlar JavaScript ile yÃ¼klenecek -->
        </tbody>
    </table>
    <button id="close-scoreboard-button">close</button>
</div>

<!-- Skorboard butonunu main menu'ye ekleyin (username-container iÃ§ine) -->
<button id="show-scoreboard-button" style="margin-top: 15px;">Scoreboard</button>

<!-- Oyun bitti ekranÄ±na Skorboard butonu ekleyin -->
<button id="show-final-scoreboard-button" style="margin-top: 10px;">Show the Scoreboard</button>


    <div id="game-over-container">
        <h2>Game Finished!</h2>
        <p>Congratulations, all levels completed!!</p>
        <p>Final Score: <span id="final-score">0</span></p>
        <p>Total Game Time: <span id="total-completion-time">0</span> seconds</p>
        <div class="selections-history">
            <h3>all choice history</h3>
            <ul id="final-history"></ul>
        </div>
        <button id="restart-button">Play again</button>
    </div>

     <% if (error) { %>
        <p id="error-message"><%= error %></p>
    <% } %>

    <script>
        // --- Veriyi EJS'den Alma ---
        const allWordsData = <%- JSON.stringify(sozcukler) %>;
        const originalWordList = Object.keys(allWordsData);

        // --- DOM Elementleri ---
        const mainTitle = document.getElementById('main-title');
        const usernameContainer = document.getElementById('username-container');
        const gameContainer = document.getElementById('game-container');
        const phaseTransitionContainer = document.getElementById('phase-transition-container');
        const gameOverContainer = document.getElementById('game-over-container');
        const timerContainer = document.getElementById('timer-container');
        const timerDisplay = document.getElementById('timer');

        const usernameInput = document.getElementById('username-input');
        const saveUsernameButton = document.getElementById('save-username-button');
        const usernameDisplay = document.getElementById('username-display');
        const scoreDisplay = document.getElementById('score');
        const sentenceDisplay = document.getElementById('sentence-display'); // AÅŸama 2 iÃ§in
        const speakButton = document.getElementById('speak-button');
        const choicesContainer = document.getElementById('choices-container');
        const nextButton = document.getElementById('next-button');
        const phaseScoreDisplay = document.getElementById('phase-score');
        const startPhase2Button = document.getElementById('start-phase2-button');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-button');
        const errorMessage = document.getElementById('error-message');
        const phase1CompletionTime = document.getElementById('phase1-completion-time');
        const totalCompletionTime = document.getElementById('total-completion-time');
        

        // --- Oyun DeÄŸiÅŸkenleri ---
        let currentPhase = 1;
        let currentScore = 0;
        let shuffledWordsPhase1 = [];
        let shuffledWordsPhase2 = [];
        let wordPointer = 0; // Mevcut listedeki sÄ±ra
        let currentWordData = null;
        let correctAnswer = '';
        let speechSupported = ('speechSynthesis' in window);
        let currentUsername = '';
        
        // ZamanlayÄ±cÄ± deÄŸiÅŸkenleri
        let timeRemaining = 60;
        let timerInterval = null;
        let gameStartTime = 0;
        let phase1EndTime = 0;
        let gameEndTime = 0;
        let phase1Duration = 0;
        let totalGameDuration = 0;
        
        // SeÃ§im geÃ§miÅŸi iÃ§in yeni eklenen deÄŸiÅŸken
        let selectionHistory = [];

        // --- Ã‡erez (Cookie) FonksiyonlarÄ± ---
        function setCookie(name, value, days) { /* ... (Ã¶ncekiyle aynÄ±, ama artÄ±k kullanÄ±lmÄ±yor) ... */ }
        function getCookie(name) { /* ... (Ã¶ncekiyle aynÄ±) ... */ }
        function deleteCookie(name) {
            document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; SameSite=Lax';
        }

        // --- YardÄ±mcÄ± Fonksiyonlar ---
        function shuffleArray(array) {
            let newArray = [...array]; // Orijinal diziyi bozmamak iÃ§in kopyala
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // --- ZamanlayÄ±cÄ± FonksiyonlarÄ± ---
        function startTimer() {
            timerContainer.style.display = 'block';
            timerDisplay.textContent = timeRemaining;
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = timeRemaining;
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeUp();
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function resetTimer() {
            stopTimer();
            timeRemaining = 60;
            timerDisplay.textContent = timeRemaining;
        }
        
        // --- Rank GÃ¶nderme Fonksiyonu ---
        function sendRank() {
            const payload = {
                username: currentUsername,
                score: currentScore,
                totalTime: totalGameDuration
            };
            fetch('https://english.secaltubitak.site/hardRank', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) throw new Error('Sunucu hatasÄ±');
                return response.json();
            })
            .then(data => console.log('Rank kaydedildi:', data))
            .catch(err => console.error('Rank kaydedilirken hata:', err));
        }
        
        function handleTimeUp() {
            stopTimer();
            gameEndTime = Date.now();
            totalGameDuration = Math.floor((gameEndTime - gameStartTime) / 1000);
            
            // Rank sistemine puanÄ± gÃ¶nder
            sendRank();
            
            gameContainer.style.display = 'none';
            finalScoreDisplay.textContent = currentScore;
            totalCompletionTime.textContent = totalGameDuration;
            renderSelectionHistory('final-history'); // SeÃ§im geÃ§miÅŸini gÃ¶ster
            gameOverContainer.style.display = 'block';
            mainTitle.textContent = "Oyun Bitti! - SÃ¼re Doldu";
            timerContainer.style.display = 'none';
        }

        // --- KonuÅŸma Fonksiyonu ---
        function speakContent() {
            if (!speechSupported) {
                console.warn("TarayÄ±cÄ±nÄ±z konuÅŸma sentezini desteklemiyor.");
                return;
            }
            if (!correctAnswer) return; // HenÃ¼z kelime seÃ§ilmediyse

            let textToSpeak = '';
            if (currentPhase === 1) {
                textToSpeak = correctAnswer; // AÅŸama 1: Kelimeyi oku
            } else {
                // AÅŸama 2: Tam cÃ¼mleyi oku
                textToSpeak = allWordsData[correctAnswer]?.cumle?.tam || correctAnswer; // CÃ¼mle yoksa kelimeyi oku
            }

            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';
            utterance.rate = 0.5; // YavaÅŸ hÄ±z
            window.speechSynthesis.speak(utterance);
        }

        // --- SeÃ§im GeÃ§miÅŸi GÃ¶rÃ¼ntÃ¼leme Fonksiyonu ---
        function renderSelectionHistory(containerId, phase = null) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const filtered = phase ? 
                selectionHistory.filter(item => item.phase === phase) : 
                selectionHistory;
            
            container.innerHTML = filtered.map((item, index) => `
                <li class="${item.isCorrect ? 'correct' : 'incorrect'}">
                    ${index + 1}. Question - Word: "${item.word}" â†’ 
                    Chosen: "${item.selected}" 
                    (${item.isCorrect ? 'âœ“' : 'âœ—'})
                </li>
            `).join('');
        }

        // --- Oyun MantÄ±ÄŸÄ± ---
        function loadNextWord() {
            const currentList = currentPhase === 1 ? shuffledWordsPhase1 : shuffledWordsPhase2;

            // Mevcut aÅŸamanÄ±n kelimeleri bitti mi?
            if (wordPointer >= currentList.length) {
                if (currentPhase === 1) {
                    // AÅŸama 1 bitti, AÅŸama 2'ye geÃ§iÅŸ ekranÄ±nÄ± gÃ¶ster
                    stopTimer();
                    phase1EndTime = Date.now();
                    phase1Duration = Math.floor((phase1EndTime - gameStartTime) / 1000);
                    
                    gameContainer.style.display = 'none';
                    phaseScoreDisplay.textContent = currentScore;
                    phase1CompletionTime.textContent = phase1Duration;
                    renderSelectionHistory('phase1-history', 1); // AÅŸama 1 geÃ§miÅŸini gÃ¶ster
                    phaseTransitionContainer.style.display = 'block';
                    mainTitle.textContent += " - level 1 completed";
                    timerContainer.style.display = 'none';
                } else {
                    // AÅŸama 2 bitti, Oyun Sonu ekranÄ±nÄ± gÃ¶ster
                    stopTimer();
                    gameEndTime = Date.now();
                    totalGameDuration = Math.floor((gameEndTime - gameStartTime) / 1000);
                    
                    // Rank sistemine puanÄ± gÃ¶nder
                    sendRank();
                    
                    gameContainer.style.display = 'none';
                    finalScoreDisplay.textContent = currentScore;
                    totalCompletionTime.textContent = totalGameDuration;
                    renderSelectionHistory('final-history'); // TÃ¼m seÃ§im geÃ§miÅŸini gÃ¶ster
                    gameOverContainer.style.display = 'block';
                    mainTitle.textContent = "game over!";
                    timerContainer.style.display = 'none';
                }
                return; // Ä°ÅŸlemi bitir, yeni kelime yÃ¼kleme
            }

            // Kelimeyi al ve quiz'i kur
            const nextWord = currentList[wordPointer];
            setupQuiz(nextWord);
            wordPointer++; // SÄ±radaki kelimeye geÃ§
        }

        function setupQuiz(word) {
             if (!word || !allWordsData[word]) {
                  console.error(`Kelime verisi bulunamadÄ±: ${word}`);
                  choicesContainer.innerHTML = "<p>Bu kelime iÃ§in veri bulunamadÄ±.</p>";
                  speakButton.disabled = true; nextButton.disabled = true; return;
             }

            correctAnswer = word;
            currentWordData = allWordsData[word];

            // AÅŸama 2'ye Ã¶zel: Eksik cÃ¼mleyi gÃ¶ster
            if (currentPhase === 2) {
                const incompleteSentence = currentWordData.cumle?.eksik;
                if (incompleteSentence) {
                    sentenceDisplay.textContent = incompleteSentence;
                    sentenceDisplay.style.display = 'block';
                } else {
                    sentenceDisplay.style.display = 'none'; // CÃ¼mle yoksa gizle
                }
                speakButton.textContent = "ðŸ”Š Listen to the sentence";
                speakButton.title = "listen full sentences";
            } else {
                sentenceDisplay.style.display = 'none'; // AÅŸama 1'de cÃ¼mle alanÄ±nÄ± gizle
                speakButton.textContent = "ðŸ”Š listen the word";
                speakButton.title = "listen the word";
            }

            // ÅžÄ±klarÄ± oluÅŸtur (AÅŸama 1 ve 2 iÃ§in aynÄ± mantÄ±k)
            let choices = [correctAnswer];
            let similarWords = currentWordData.benzerler ? shuffleArray([...currentWordData.benzerler]) : [];
             const correctIndexInSimilar = similarWords.indexOf(correctAnswer);
             if (correctIndexInSimilar > -1) { similarWords.splice(correctIndexInSimilar, 1); }

             const distractorsNeeded = 3;
             for(let i = 0; i < similarWords.length && choices.length < (distractorsNeeded + 1); i++) {
                 if(!choices.includes(similarWords[i])) { choices.push(similarWords[i]); }
             }
            // Distractors'i karÄ±ÅŸtÄ±r ve 3 ÅŸÄ±ka dÃ¶nÃ¼ÅŸtÃ¼r (doÄŸru cevap ile toplam 4 ÅŸÄ±k)
            choices = shuffleArray([correctAnswer, ...similarWords.slice(0, 3)]);

            // ButonlarÄ± oluÅŸtur
            choicesContainer.innerHTML = '';
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.classList.add('choice-button');
                button.textContent = choice;
                button.dataset.answer = choice;
                button.addEventListener('click', handleAnswerClick);
                choicesContainer.appendChild(button);
            });

            speakButton.disabled = false;
            nextButton.disabled = true; // Cevap verilince aktifleÅŸecek
        }

        function handleAnswerClick(event) {
            const selectedButton = event.target;
            const selectedAnswer = selectedButton.dataset.answer;
            const allChoiceButtons = choicesContainer.querySelectorAll('.choice-button');
            allChoiceButtons.forEach(btn => btn.disabled = true);

            if (selectedAnswer === correctAnswer) {
                selectedButton.classList.add('correct');
                currentScore += 5;
                scoreDisplay.textContent = currentScore; // Skoru ekranda gÃ¼ncelle
            } else {
                selectedButton.classList.add('incorrect');
                const correctButton = choicesContainer.querySelector(`.choice-button[data-answer="${correctAnswer}"]`);
                if (correctButton) { correctButton.classList.add('correct'); }
            }
            
            // SeÃ§im geÃ§miÅŸine ekleme
            selectionHistory.push({
                phase: currentPhase,
                word: correctAnswer,
                selected: selectedAnswer,
                isCorrect: selectedAnswer === correctAnswer,
                timestamp: new Date().toLocaleTimeString()
            });
            
            nextButton.disabled = false; // Ä°lerle butonunu aktif et
        }

        function startPhase2() {
            currentPhase = 2;
            wordPointer = 0; // SayacÄ± sÄ±fÄ±rla
            shuffledWordsPhase2 = shuffleArray(originalWordList); // AÅŸama 2 iÃ§in listeyi karÄ±ÅŸtÄ±r

            phaseTransitionContainer.style.display = 'none'; // GeÃ§iÅŸ ekranÄ±nÄ± gizle
            gameContainer.style.display = 'block';          // Oyun ekranÄ±nÄ± gÃ¶ster
            mainTitle.textContent = "Let's Pronounce Correctly! Level 2"; // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
            scoreDisplay.textContent = currentScore; // Skoru tekrar yaz (gerekliyse)
            usernameDisplay.textContent = currentUsername; // KullanÄ±cÄ± adÄ±nÄ± tekrar yaz
            
            // AÅŸama 1 seÃ§im geÃ§miÅŸini render et
            renderSelectionHistory('phase1-history', 1);
            
            // AÅŸama 2 iÃ§in zamanlayÄ±cÄ±yÄ± yeniden baÅŸlat
            resetTimer();
            startTimer();
            timerContainer.style.display = 'block';

            loadNextWord(); // AÅŸama 2'nin ilk kelimesini yÃ¼kle
        }

        function restartGame() {
            // Oyun yeniden baÅŸlatÄ±lmadan Ã¶nce son kez seÃ§im geÃ§miÅŸini gÃ¶ster
            renderSelectionHistory('final-history');
            window.location.reload(); // SayfayÄ± yeniden yÃ¼kleyerek oyunu sÄ±fÄ±rla
        }

        // --- BaÅŸlangÄ±Ã§ AyarlarÄ± ---
        function initializeGame() {
            console.log("Oyun baÅŸlatÄ±lÄ±yor, Ã§erezler siliniyor...");
            deleteCookie('username');
            deleteCookie('score');

            if (errorMessage) {
                 console.error("Sunucu HatasÄ±:", errorMessage.textContent);
                 usernameContainer.style.display = 'none'; return;
             }
             if (originalWordList.length === 0 && !errorMessage) {
                 console.error("BaÅŸlatÄ±lacak kelime bulunamadÄ±.");
                 usernameContainer.innerHTML = "<p>Oyun baÅŸlatÄ±lamÄ±yor. Kelime verisi yok.</p>";
                 usernameContainer.style.display = 'block'; return;
             }

            // Her zaman kullanÄ±cÄ± adÄ± giriÅŸi ile baÅŸla
            usernameContainer.style.display = 'block';
            gameContainer.style.display = 'none';
            phaseTransitionContainer.style.display = 'none';
            gameOverContainer.style.display = 'none';
            timerContainer.style.display = 'none';

            // --- Event Listener'lar ---
            saveUsernameButton.addEventListener('click', () => {
                currentUsername = usernameInput.value.trim(); // KullanÄ±cÄ± adÄ±nÄ± deÄŸiÅŸkene ata
                if (currentUsername) {
                    usernameDisplay.textContent = currentUsername; // Ekranda gÃ¶ster
                    currentScore = 0; // Skoru sÄ±fÄ±rla
                    scoreDisplay.textContent = currentScore;
                    currentPhase = 1; // AÅŸama 1'den baÅŸla
                    wordPointer = 0; // SayacÄ± sÄ±fÄ±rla
                    shuffledWordsPhase1 = shuffleArray(originalWordList); // AÅŸama 1 listesini karÄ±ÅŸtÄ±r
                    selectionHistory = []; // SeÃ§im geÃ§miÅŸini temizle

                    usernameContainer.style.display = 'none'; // GiriÅŸ ekranÄ±nÄ± gizle
                    gameContainer.style.display = 'block';     // Oyun ekranÄ±nÄ± gÃ¶ster
                    mainTitle.textContent = "Let's Pronounce Correctly! Level 1"; // BaÅŸlÄ±ÄŸÄ± ayarla
                    
                    // Oyunu baÅŸlat ve zamanlayÄ±cÄ±yÄ± baÅŸlat
                    gameStartTime = Date.now();
                    startTimer();

                    loadNextWord(); // AÅŸama 1'in ilk kelimesini yÃ¼kle
                } else {
                    alert('LÃ¼tfen geÃ§erli bir kullanÄ±cÄ± adÄ± girin.');
                }
            });

            speakButton.addEventListener('click', speakContent); // GÃ¼ncellenmiÅŸ konuÅŸma fonksiyonunu Ã§aÄŸÄ±r
            nextButton.addEventListener('click', loadNextWord);
            startPhase2Button.addEventListener('click', startPhase2); // AÅŸama 2'yi baÅŸlatan butona olay ekle
            restartButton.addEventListener('click', restartGame); // Yeniden baÅŸlatma butonuna olay ekle
        }

        // Sayfa yÃ¼klendiÄŸinde oyunu baÅŸlat
        window.addEventListener('DOMContentLoaded', initializeGame);


        
        let scoreboardContainer;
    let scoreboardBody;
    let showScoreboardButton;
    let showFinalScoreboardButton;
    let closeScoreboardButton;
    
    // Skor verileri - oyun sonunda doldurulacak
    let rankData = null;
    
    // Skorboard'u yÃ¼kleme fonksiyonu
    function loadScoreboard() {
        // EÄŸer zaten rankData varsa, onu kullan
        if (rankData) {
            displayScoreboard(rankData);
            return;
        }
        
        // Veri yoksa yÃ¼kleniyor gÃ¶ster
        scoreboardBody.innerHTML = '<tr><td colspan="5"><div class="loader"></div><p>Skorlar yÃ¼kleniyor...</p></td></tr>';
        
        // Son rank gÃ¶nderiminin yanÄ±tÄ±nÄ± kullan ya da oyun sonunda kaydedilen veriyi kullan
        fetch('https://english.secaltubitak.site/hardRank', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: "score_query", // Sadece veri almak iÃ§in geÃ§ici istek
                score: 0,
                totalTime: 0
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Sunucu hatasÄ±');
            return response.json();
        })
        .then(data => {
            rankData = data.data || [];
            displayScoreboard(rankData);
        })
        .catch(err => {
            console.error('Skorboard yÃ¼klenirken hata:', err);
            scoreboardBody.innerHTML = '<tr><td colspan="5">Skorlar yÃ¼klenemedi. LÃ¼tfen daha sonra tekrar deneyin.</td></tr>';
        });
    }
    
    // Skorboard'u gÃ¶sterme fonksiyonu
    function displayScoreboard(scores) {
        if (!Array.isArray(scores) || scores.length === 0) {
            scoreboardBody.innerHTML = '<tr><td colspan="5">HenÃ¼z hiÃ§ skor kaydedilmemiÅŸ.</td></tr>';
            return;
        }
        
        // SkorlarÄ± sÄ±rala: Ã–nce puana gÃ¶re azalan, sonra sÃ¼reye gÃ¶re artan
        const sortedScores = scores.sort((a, b) => {
            if (b.score !== a.score) {
                return b.score - a.score; // YÃ¼ksek puan Ã¶nce
            }
            return a.totalTime - b.totalTime; // AynÄ± puanda dÃ¼ÅŸÃ¼k sÃ¼re Ã¶nce
        });
        
        // Tabloyu oluÅŸtur
        scoreboardBody.innerHTML = '';
        sortedScores.forEach((score, index) => {
            const row = document.createElement('tr');
            
            // Ä°lk 3 sÄ±ra iÃ§in Ã¶zel sÄ±nÄ±f ekle
            if (index === 0) row.classList.add('top-1');
            else if (index === 1) row.classList.add('top-2');
            else if (index === 2) row.classList.add('top-3');
            
            // Tarih formatla
            const scoreDate = new Date(score.createdAt);
            const formattedDate = `${scoreDate.toLocaleDateString()} ${scoreDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${score.username}</td>
                <td>${score.score}</td>
                <td>${score.totalTime}</td>
                <td>${formattedDate}</td>
            `;
            scoreboardBody.appendChild(row);
        });
    }
    
    // Mevcut sendRank fonksiyonunu dÃ¼zenleme
    const originalSendRank = sendRank;
    sendRank = function() {
        const payload = {
            username: currentUsername,
            score: currentScore,
            totalTime: totalGameDuration
        };
        
        fetch('https://english.secaltubitak.site/hardRank', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) throw new Error('Sunucu hatasÄ±');
            return response.json();
        })
        .then(data => {
            console.log('Rank kaydedildi:', data);
            // Rank verilerini sakla
            if (data && data.data) {
                rankData = data.data;
            }
        })
        .catch(err => console.error('Rank kaydedilirken hata:', err));
    };
    
    // Skorboard'u gÃ¶ster
    function showScoreboard() {
        // DiÄŸer konteynerlarÄ± gizle
        usernameContainer.style.display = 'none';
        gameContainer.style.display = 'none';
        phaseTransitionContainer.style.display = 'none';
        gameOverContainer.style.display = 'none';
        timerContainer.style.display = 'none';
        
        // Skorboard'u gÃ¶ster
        scoreboardContainer.style.display = 'block';
        loadScoreboard();
    }
    
    // Skorboard'u kapat
    function closeScoreboard() {
        scoreboardContainer.style.display = 'none';
        
        // Oyun durumuna gÃ¶re uygun ekranÄ± tekrar gÃ¶ster
        if (gameEndTime > 0) {
            gameOverContainer.style.display = 'block';
        } else if (phase1EndTime > 0 && currentPhase === 1) {
            phaseTransitionContainer.style.display = 'block';
        } else if (currentUsername) {
            gameContainer.style.display = 'block';
            if (timerInterval) timerContainer.style.display = 'block';
        } else {
            usernameContainer.style.display = 'block';
        }
    }
    
    // DOM hazÄ±r olduÄŸunda skorboard elemanlarÄ±nÄ± oluÅŸtur ve baÄŸla
    function initScoreboard() {
        // EÄŸer HTML'de zaten eklenmiÅŸse elemanlarÄ± bul
        scoreboardContainer = document.getElementById('scoreboard-container');
        scoreboardBody = document.getElementById('scoreboard-body');
        showScoreboardButton = document.getElementById('show-scoreboard-button');
        showFinalScoreboardButton = document.getElementById('show-final-scoreboard-button');
        closeScoreboardButton = document.getElementById('close-scoreboard-button');
        
        // Ana menÃ¼ye skorboard butonu ekle
        if (usernameContainer && !showScoreboardButton) {
            showScoreboardButton = document.createElement('button');
            showScoreboardButton.id = 'show-scoreboard-button';
            showScoreboardButton.textContent = 'Skorboard';
            showScoreboardButton.style.marginTop = '15px';
            usernameContainer.appendChild(showScoreboardButton);
        }
        
        // Oyun sonu ekranÄ±na skorboard butonu ekle
        if (gameOverContainer && !showFinalScoreboardButton) {
            showFinalScoreboardButton = document.createElement('button');
            showFinalScoreboardButton.id = 'show-final-scoreboard-button';
            showFinalScoreboardButton.textContent = 'Skorboard\'u GÃ¶rÃ¼ntÃ¼le';
            showFinalScoreboardButton.style.marginTop = '10px';
            const restartButton = document.getElementById('restart-button');
            restartButton.parentNode.insertBefore(showFinalScoreboardButton, restartButton);
        }
        
        // Olay dinleyicileri baÄŸla
        if (showScoreboardButton) showScoreboardButton.addEventListener('click', showScoreboard);
        if (showFinalScoreboardButton) showFinalScoreboardButton.addEventListener('click', showScoreboard);
        if (closeScoreboardButton) closeScoreboardButton.addEventListener('click', closeScoreboard);
    }
    
    // Orijinal baÅŸlatma fonksiyonunu geniÅŸlet
    const originalInitializeGame = window.initializeGame || function(){};
    window.initializeGame = function() {
        originalInitializeGame();
        initScoreboard();
    };
    
    // Sayfa yÃ¼klendiÄŸinde skorboard hazÄ±rlÄ±klarÄ±nÄ± yap
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initScoreboard);
    } else {
        initScoreboard();
    }
    </script>

</body>
</html>
